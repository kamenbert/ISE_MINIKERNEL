

# generation du boot
cc -m32 -traditional -E -Iinclude boot/bootsect.S > tmp/bootsect.s 
as86 -0 -a -o tmp/bootsect.o tmp/bootsect.s
ld86 -0 -s -o tmp/bootsect tmp/bootsect.o
cc -m32 -traditional -E -Iinclude boot/setup.S > tmp/setup.s
as86 -0 -a -o tmp/setup.o tmp/setup.s
ld86 -0 -s -o tmp/setup tmp/setup.o

# generation du mini_kernel de base 
gcc -m32 minikernel_init/gidt.c -o tmp/gidt ; tmp/gidt > minikernel_init/idt.h
gcc -m32 -traditional -Iinclude -c minikernel_init/head.S -o tmp/head.o
gcc -m32 -Iinclude -c minikernel_init/util.c -o tmp/util.o
gcc -m32 -traditional -Iinclude -c minikernel_init/keyboard_irq.S -o tmp/keyboard_irq.o
gcc -m32 -Iinclude -c minikernel_init/keyboard.c -o tmp/keyboard.o
gcc -m32 -traditional -Iinclude -c minikernel_init/syscall_handler.S -o tmp/syscall_handler.o
gcc -m32 -Iinclude -c minikernel_init/syscall.c -o tmp/syscall.o
gcc -m32 -Iinclude -c minikernel_init/sys_functions.c -o tmp/sys_functions.o
gcc -m32 -Iinclude -fno-stack-protector -c minikernel_init/vga.c -o tmp/vga.o
gcc -m32 -Iinclude -c minikernel_init/process.c -o tmp/process.o
gcc -m32 -Iinclude -c minikernel_init/main.c -o tmp/main.o
gcc -m32 -Iinclude -c minikernel_init/ttyS_asm.S -o tmp/ttyS_asm.o
gcc -m32 -Iinclude -c minikernel_init/ttyS.c -o tmp/ttyS.o


# generation du mini_kernel  user 
gcc -m32 -Iinclude -c minikernel_user/entry.c -o tmp/entry.o
gcc -m32 -Iinclude -c minikernel_user/ttyS_util.S -o tmp/ttyS_util.o

# generation du kernel
ld  -m elf_i386 -Ttext 0x1000 -e startup_32 -o tmp/minikernel.elf \
	tmp/head.o \
	tmp/util.o \
	tmp/keyboard_irq.o \
	tmp/keyboard.o \
	tmp/syscall_handler.o \
	tmp/syscall.o \
	tmp/sys_functions.o \
	tmp/vga.o \
	tmp/process.o \
	tmp/main.o \
	tmp/ttyS_asm.o \
	tmp/ttyS.o \
	tmp/entry.o \
	tmp/ttyS_util.o
objcopy -O binary -R .note -R .comment -S tmp/minikernel.elf tmp/minikernel

# generation de l'image bootable
test -f tmp/build || cc boot/build.c -o tmp/build
tmp/build tmp/bootsect tmp/setup tmp/minikernel > mykernel
dd if=mykernel of=mykernel.vfd count=1 bs=1474560 conv=sync
